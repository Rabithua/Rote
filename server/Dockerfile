FROM node:lts-alpine

ENV NODE_ENV=production

# å®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„åŒ…å’Œå·¥å…·ï¼ˆåˆå¹¶ RUN å‡å°‘å±‚æ•°ï¼‰
RUN apk add --no-cache openssl su-exec && \
    addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /usr/src/app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å’Œæºä»£ç 
COPY package.json package-lock.json* ./
COPY . .

# åˆ›å»ºå¯åŠ¨è„šæœ¬å’Œå…¥å£è„šæœ¬ï¼ˆåˆå¹¶ RUN å‡å°‘å±‚æ•°ï¼‰
RUN cat > /usr/src/app/docker-start.sh << 'EOFSCRIPT' && chmod +x /usr/src/app/docker-start.sh && \
    cat > /usr/src/app/docker-entrypoint.sh << 'EOFENTRY' && chmod +x /usr/src/app/docker-entrypoint.sh
#!/bin/sh
set -e

# æ£€æŸ¥ node_modules æ˜¯å¦å­˜åœ¨ä¸” package.json æœªå˜æ›´
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.package-lock.json" ] || [ package.json -nt node_modules/.package-lock.json ]; then
  echo "ğŸ“¦ Installing production dependencies..."
  if [ -f "package-lock.json" ]; then
    npm ci --omit=dev || npm install --omit=dev
  else
    npm install --omit=dev
  fi
  echo "ğŸ“¦ Installing build tools..."
  npm install --save-dev ts-node prisma typescript @types/node || true
  npm cache clean --force
  touch node_modules/.package-lock.json
else
  echo "âœ… Using cached dependencies"
  if [ ! -d "node_modules/ts-node" ]; then
    echo "ğŸ“¦ Installing build tools..."
    npm install --save-dev ts-node prisma typescript @types/node || true
  fi
fi

echo "ğŸ”§ Generating Prisma Client..."
npx prisma generate

echo "ğŸ”§ Pushing database schema..."
npx prisma db push || true

echo "ğŸš€ Starting server..."
exec npm start
EOFSCRIPT
#!/bin/sh
set -e

# å¦‚æœ node_modules ç›®å½•å­˜åœ¨ï¼ˆvolume æŒ‚è½½ï¼‰ï¼Œä¿®å¤æƒé™
if [ -d "node_modules" ]; then
  echo "ğŸ”§ Fixing node_modules permissions..."
  chown -R nodejs:nodejs node_modules 2>/dev/null || true
fi

# åˆ‡æ¢åˆ° nodejs ç”¨æˆ·å¹¶æ‰§è¡Œå¯åŠ¨è„šæœ¬
exec su-exec nodejs /usr/src/app/docker-start.sh
EOFENTRY

# è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆä»¥ root èº«ä»½ï¼‰
RUN chown -R nodejs:nodejs /usr/src/app

# ä¿æŒ root ç”¨æˆ·ï¼Œåœ¨ entrypoint ä¸­åˆ‡æ¢
EXPOSE 3000

ENTRYPOINT ["/usr/src/app/docker-entrypoint.sh"]
