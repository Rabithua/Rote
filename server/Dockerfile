# ----------------------------------------------------
# é˜¶æ®µ 1: ä¾èµ–å®‰è£…å’Œ Prisma å®¢æˆ·ç«¯ç”Ÿæˆ (deps)
# ----------------------------------------------------
FROM oven/bun:1-alpine AS deps

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜å±‚ï¼‰
COPY package.json bun.lock* ./

# ğŸš¨ å…³é”®ï¼šåªå®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–ï¼
RUN bun install --production --frozen-lockfile

# å¤åˆ¶ schema å¹¶ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
COPY prisma ./prisma
RUN bunx prisma generate

# ----------------------------------------------------
# é˜¶æ®µ 2: ä»£ç ç¼–è¯‘ (builder)
# ----------------------------------------------------
FROM oven/bun:1-alpine AS builder

WORKDIR /app

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œç¼–è¯‘æ—¶éœ€è¦ TypeScriptï¼‰
COPY package.json bun.lock* ./
RUN bun install --frozen-lockfile

# ä» deps é˜¶æ®µå¤åˆ¶ Prisma Clientï¼ˆé¿å…é‡æ–°ç”Ÿæˆï¼‰
COPY --from=deps /app/node_modules/.prisma ./node_modules/.prisma

# å¤åˆ¶æºä»£ç 
COPY . .

# ç¼–è¯‘æ‰€æœ‰ TypeScript ä»£ç åˆ° dist ç›®å½•
RUN bun run build

# ----------------------------------------------------
# é˜¶æ®µ 3: è¿è¡Œæ—¶é•œåƒ (runner) - æè‡´ç˜¦èº«ï¼
# ----------------------------------------------------
FROM oven/bun:1-alpine AS runner

WORKDIR /app

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 bunuser

# å¤åˆ¶ package.json å’Œ lockfileï¼ˆç”¨äºé‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–ï¼‰
COPY --from=builder --chown=bunuser:nodejs /app/package.json ./
COPY --from=builder --chown=bunuser:nodejs /app/bun.lock* ./

# ğŸš¨ å…³é”®ä¼˜åŒ–ï¼šåœ¨ runner é˜¶æ®µé‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–
# è¿™æ ·å¯ä»¥ç¡®ä¿å®Œå…¨æ²¡æœ‰ devDependenciesï¼Œå¹¶ä¸”åªå®‰è£…è¿è¡Œæ—¶éœ€è¦çš„åŒ…
RUN bun install --production --frozen-lockfile

# ä» deps é˜¶æ®µå¤åˆ¶ Prisma Client å’Œ schemaï¼ˆPrisma æ˜¯ç”Ÿäº§ä¾èµ–ï¼‰
# æ³¨æ„ï¼šå…ˆå¤åˆ¶ node_modulesï¼Œå†å¤åˆ¶ .prismaï¼Œç¡®ä¿ç›®å½•ç»“æ„æ­£ç¡®
COPY --from=deps --chown=bunuser:nodejs /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=deps --chown=bunuser:nodejs /app/prisma ./prisma

# ç¡®ä¿ Prisma Client ç›®å½•æƒé™æ­£ç¡®
RUN chown -R bunuser:nodejs /app/node_modules/.prisma || true

# ä» builder é˜¶æ®µå¤åˆ¶ç¼–è¯‘åçš„ä»£ç 
COPY --from=builder --chown=bunuser:nodejs /app/dist ./dist

# ğŸ”¥ ç»ˆææ¸…ç†ï¼šåˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„æ–‡ä»¶
RUN rm -rf /app/node_modules/.cache && \
    rm -rf /tmp/* && \
    rm -rf /var/cache/apk/* && \
    # ğŸš¨ å¼ºåˆ¶åˆ é™¤ TypeScript åŠå…¶ç›¸å…³åŒ…ï¼ˆPrisma çš„å¯é€‰ peer dependencyï¼Œç”Ÿäº§ç¯å¢ƒä¸éœ€è¦ï¼‰
    rm -rf /app/node_modules/typescript && \
    rm -rf /app/node_modules/@typescript-eslint && \
    rm -rf /app/node_modules/typescript-eslint && \
    # ğŸš¨ Prisma ä¼˜åŒ–ï¼šåˆ é™¤ä¸éœ€è¦çš„æ•°æ®åº“å¼•æ“æ–‡ä»¶ï¼ˆåªä¿ç•™ PostgreSQLï¼‰
    find /app/node_modules/prisma/build -name '*cockroachdb*' -delete 2>/dev/null || true && \
    find /app/node_modules/prisma/build -name '*mysql*' -delete 2>/dev/null || true && \
    find /app/node_modules/prisma/build -name '*sqlite*' -delete 2>/dev/null || true && \
    find /app/node_modules/prisma/build -name '*sqlserver*' -delete 2>/dev/null || true && \
    # åˆ é™¤æµ‹è¯•ç›¸å…³ç›®å½•
    find /app/node_modules -type d \( -name "test" -o -name "tests" -o -name "__tests__" -o -name "*.test.*" -o -name "*.spec.*" -o -name "docs" -o -name "doc" -o -name "examples" -o -name "example" -o -name "benchmark" -o -name "benchmarks" \) -exec rm -rf {} + 2>/dev/null || true && \
    # åˆ é™¤æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶
    find /app/node_modules -type f \( -name "*.md" -o -name "*.map" -o -name "CHANGELOG*" -o -name "LICENSE*" -o -name "README*" -o -name "*.ts" -o -name "*.tsx" -o -name "*.json" ! -name "package.json" \) ! -path "*/node_modules/.prisma/*" ! -path "*/node_modules/@types/*" -delete 2>/dev/null || true && \
    # åˆ é™¤ç±»å‹å®šä¹‰æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶ä¸éœ€è¦ï¼‰
    find /app/node_modules -type f -name "*.d.ts" ! -path "*/node_modules/.prisma/*" ! -path "*/node_modules/@types/*" -delete 2>/dev/null || true && \
    # åˆ é™¤æºç æ–‡ä»¶ï¼ˆåªä¿ç•™ç¼–è¯‘åçš„ä»£ç ï¼‰
    find /app/node_modules -type f \( -name "*.js" ! -name "*.min.js" \) -path "*/src/*" -delete 2>/dev/null || true

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæå‡æ€§èƒ½
ENV NODE_ENV=production

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER bunuser

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD bun -e "fetch('http://localhost:3000/v2/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" || exit 1

# å¯åŠ¨å‘½ä»¤ï¼šæŒ‡å‘ç¼–è¯‘åçš„å…¥å£æ–‡ä»¶
CMD ["bun", "run", "dist/server.js"]
