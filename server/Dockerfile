# ----------------------------------------------------
# é˜¶æ®µ 1: ä¾èµ–å®‰è£… (deps)
# ----------------------------------------------------
FROM oven/bun:1-alpine AS deps

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜å±‚ï¼‰
COPY package.json bun.lock* ./

# ğŸš¨ å…³é”®ï¼šåªå®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–ï¼
RUN bun install --production --frozen-lockfile

# ----------------------------------------------------
# é˜¶æ®µ 2: ä»£ç ç¼–è¯‘ (builder)
# ----------------------------------------------------
FROM oven/bun:1-alpine AS builder

WORKDIR /app

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œç¼–è¯‘æ—¶éœ€è¦ TypeScriptï¼‰
COPY package.json bun.lock* ./
RUN bun install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# ç¼–è¯‘æ‰€æœ‰ TypeScript ä»£ç åˆ° dist ç›®å½•
RUN bun run build

# ----------------------------------------------------
# é˜¶æ®µ 3: è¿è¡Œæ—¶é•œåƒ (runner) - æè‡´ç˜¦èº«ï¼
# ----------------------------------------------------
FROM oven/bun:1-alpine AS runner

WORKDIR /app

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 bunuser

# å¤åˆ¶ package.json å’Œ lockfileï¼ˆç”¨äºé‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–ï¼‰
COPY --from=builder --chown=bunuser:nodejs /app/package.json ./
COPY --from=builder --chown=bunuser:nodejs /app/bun.lock* ./

# ğŸš¨ å…³é”®ä¼˜åŒ–ï¼šåªå®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆå·²æ”¹ç”¨ç¨‹åºåŒ–è¿ç§»ï¼Œä¸éœ€è¦ drizzle-kitï¼‰
RUN bun install --production --frozen-lockfile

# ä» builder é˜¶æ®µå¤åˆ¶ç¼–è¯‘åçš„ä»£ç å’Œè¿ç§»æ–‡ä»¶
COPY --from=builder --chown=bunuser:nodejs /app/dist ./dist
COPY --from=builder --chown=bunuser:nodejs /app/drizzle ./drizzle

# éªŒè¯è¿ç§»æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆæ„å»ºæ—¶æ£€æŸ¥ï¼‰
RUN if [ ! -d "./drizzle/migrations" ]; then \
      echo "âŒ ERROR: drizzle/migrations directory not found!" && \
      echo "ğŸ’¡ This indicates migrations were not copied correctly during build." && \
      exit 1; \
    fi && \
    if [ ! -f "./drizzle/migrations/meta/_journal.json" ]; then \
      echo "âŒ ERROR: Migration metadata file not found!" && \
      echo "ğŸ’¡ This indicates migrations were not copied correctly during build." && \
      exit 1; \
    fi && \
    echo "âœ… Migration files verified successfully"

# ğŸ”¥ ç»ˆææ¸…ç†ï¼šåˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„æ–‡ä»¶ä»¥å‡å°é•œåƒå¤§å°
# æ³¨æ„ï¼šé¿å…åˆ é™¤å…³é”®ä¾èµ–åŒ…ï¼ˆå¦‚ postgresï¼‰çš„å¿…è¦æ–‡ä»¶
RUN rm -rf /app/node_modules/.cache /tmp/* /var/cache/apk/* && \
    # åˆ é™¤æµ‹è¯•ã€æ–‡æ¡£ã€ç¤ºä¾‹ç­‰ç›®å½•ï¼ˆæ’é™¤å…³é”®ä¾èµ–åŒ…ï¼‰
    find /app/node_modules -type d \( \
        -name "test" -o -name "tests" -o -name "__tests__" -o \
        -name "*.test.*" -o -name "*.spec.*" -o \
        -name "docs" -o -name "doc" -o \
        -name "examples" -o -name "example" -o \
        -name "benchmark" -o -name "benchmarks" \
    \) ! -path "*/node_modules/postgres/*" \
      ! -path "*/node_modules/drizzle-orm/*" \
      -exec rm -rf {} + 2>/dev/null || true && \
    # åˆ é™¤æ–‡æ¡£ã€æºç æ˜ å°„ç­‰ï¼ˆæ’é™¤å…³é”®ä¾èµ–åŒ…ï¼‰
    find /app/node_modules -type f \( \
        -name "*.md" -o -name "*.map" -o \
        -name "CHANGELOG*" -o -name "LICENSE*" -o -name "README*" \
    \) ! -path "*/node_modules/postgres/*" \
      ! -path "*/node_modules/drizzle-orm/*" \
      -delete 2>/dev/null || true && \
    # åˆ é™¤ TypeScript æºæ–‡ä»¶ï¼ˆä½†ä¿ç•™ .d.ts ç±»å‹å®šä¹‰æ–‡ä»¶ï¼ŒæŸäº›åŒ…å¯èƒ½éœ€è¦ï¼‰
    find /app/node_modules -type f \( \
        -name "*.ts" -o -name "*.tsx" \
    \) ! -name "*.d.ts" \
      ! -path "*/node_modules/@types/*" \
      ! -path "*/node_modules/postgres/*" \
      ! -path "*/node_modules/drizzle-orm/*" \
      -delete 2>/dev/null || true && \
    # åˆ é™¤ package.json ä»¥å¤–çš„ JSON é…ç½®æ–‡ä»¶ï¼ˆæ’é™¤å…³é”®ä¾èµ–åŒ…ï¼‰
    find /app/node_modules -type f -name "*.json" ! -name "package.json" ! -path "*/node_modules/@types/*" \
      ! -path "*/node_modules/postgres/*" \
      ! -path "*/node_modules/drizzle-orm/*" \
      -delete 2>/dev/null || true

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæå‡æ€§èƒ½
ENV NODE_ENV=production

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER bunuser

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD bun -e "fetch('http://localhost:3000/v2/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))" || exit 1

# å¯åŠ¨å‘½ä»¤ï¼šæŒ‡å‘ç¼–è¯‘åçš„å…¥å£æ–‡ä»¶
CMD ["bun", "run", "dist/server.js"]
